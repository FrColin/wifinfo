<!DOCTYPE html>
<!--MAKE_RESTRICT-->

<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <link rel="stylesheet" href="css/wifinfo.css">
    <link rel="stylesheet" href="css/custom.css">
    <script src="js/wifinfo.js"></script>
    <script src="js/gauge.min.js"></script>

    <style>
        canvas {
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }

    </style>

    <title>WifInfo</title>
</head>

<body>

    <div class="container">

        <!--  Onglets  -->
        <ul class="nav nav-tabs" id="myTab">
            <!-- glyph bootstrap:  https://getbootstrap.com/docs/3.3/components/ -->
            <li><a href="#tab_gauges" data-toggle="tab"><span class="glyphicon glyphicon-dashboard">&nbsp;</span>Compteur&nbsp;</span></a></li>
            <li><a href="#tab_relays" data-toggle="tab"><span class="glyphicon glyphicon-flash">&nbsp;</span>Relais&nbsp;<span class="badge" id="relays"></span></a></li>
			<li><a href="#tab_tinfo" data-toggle="tab"><span class="glyphicon glyphicon-flash">&nbsp;</span>Téléinformation&nbsp;<span class="badge"
                        id="scharge"></span></a></li>
            <li><a href="#tab_sys" data-toggle="tab"><span class="glyphicon glyphicon-cog">&nbsp;</span>Système</a></li>
            <li><a href="#tab_cfg" data-toggle="tab"><span class="glyphicon glyphicon-wrench">&nbsp;</span>Configuration</a></li>
        </ul>

        <!-- Contenu des onglets -->
        <div class="tab-content">

            <!-- tab gauges -->
            <div class="tab-pane fade" id="tab_gauges">
                <p></p>
                <style>
                   
                    .enedis div {
                        color: #000000;
                        letter-spacing: 2px;
                        text-align: left;
                        margin-left: 10px;
                    }

                    .enedis div.name {
                        font-size: 10px;
                        color: #666666;
                        text-align: center;
                    }

                    .enedis div.centre {
                        text-align: center;
                        color: #232e85;
                        font-size: 14px;
                    }

                    .enedis div.index {
                        font-size: 28px;
                        text-align: right;
                    }
                    .enedis td.bleu {
                        background-color: #11c2ee;
                    }
                    .enedis td.blanc {
                        background-color: #ffffff;
                    }
                    .enedis td.rouge {
                        background-color: #fd000d;
                    }
                    .enedis table.index {
                        margin: 10px;
                    }
                    .enedis div.tempo_color {
                        border-width: 2px;
                        
                        border-style: solid;
                        
                        border-color: #0156f9;
                        border-radius: 10px;
                    }
                    td.cpt {
                        width: 256px;
                        background-color: #cccccc;
                        border-radius: 20px;
                    }
                </style>

                <table>
                    <tr>
                        <td class="cpt">
                            <div class="enedis">
                                <div class="name centre">Index en kWH</div>
                                <table class="index">
                                    <thead>
                                        <th><div id="HCHPname" class="name">Heures Pleines</div></th>
                                        <th><div id="HCHCname" class="name">Heures Creuses</div></th>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="bleu"><div id="BBRHPJB" class="index">0</div></td>
                                            <td class="bleu"><div id="BBRHCJB" class="index">0</div></td>
                                        </tr>
                                        <tr>
                                            <td class="blanc"><div id="BBRHPJW" class="index">0</div></td>
                                            <td class="blanc"><div id="BBRHCJW" class="index">0</div></td>
                                        </tr>
                                        <tr>
                                            <td class="rouge" ><div id="BBRHPJR" class="index">0</div></td>
                                            <td class="rouge"><div id="BBRHCJR" class="index">0</div></td>
                                        </tr>
                                    </tbody>
                                </table>
                               
                               
                            </div>
                        </td>
                        <td width="20px"></td>
                        <td>
                            <canvas id="gauge-papp" ></canvas>
                            <canvas id="gauge-iinst"></canvas>
                        </td>
                    </tr>
                </table>
                <div class="text-center">
                    <br />
                    <small>Rappel: <mark>VA = W / cos &Phi;</mark> <em>(déphasage du courant par rapport à la tension)</em>
                    </small>
                </div>
            </div> <!-- tab gauges -->

            	<!-- tab Relays -->
				<div class="tab-pane fade" id="tab_relays">
                    <form class="form-horizontal row-border" method="post" data-toggle="validator" id="frm_relays" action="">
						<input type="hidden" name="save" value="1">
					<div class="panel-heading">
						<h3 class="panel-title">Changement etat des Relais suivant peridode Tempo</h3>
                    </div>
                    
                    <table 	data-toggle="table" 
									class="table table-striped table-condensed" 
									data-show-refresh="true" 
									id="tab_relays_data" 
									data-select-item-name="toolbar2">
						<thead>
							<tr>
                                <th data-align="center" rowspan="2" style="vertical-align: middle;" data-field="re" >Tempo</th>
                                <th data-align="center" colspan="2">BLEU</th>
								<th data-align="center" colspan="2">BLANC</th>
								<th data-align="center" colspan="2">ROUGE</th>
								<th data-align="center" rowspan="2" data-field="switch" data-formatter="relayFormatter">Etat</th>
							</tr>
							<tr>
                                <th data-field="hcjb" data-formatter="relayFormatter" data-align="center">Creuse</th>
								<th data-field="hpjb" data-formatter="relayFormatter" data-align="center">Pleine</th>
								<th data-field="hcjw" data-formatter="relayFormatter" data-align="center">Creuse</th>
								<th data-field="hpjw" data-formatter="relayFormatter" data-align="center">Pleine</th>
								<th data-field="hcjr" data-formatter="relayFormatter" data-align="center">Creuse</th>
                                <th data-field="hpjr" data-formatter="relayFormatter" data-align="center">Pleine</th>
                                
							</tr>
						</thead>
						
					</table>
					<div class="panel-footer">
						<div class="text-center">
							<div class="btn-group">
								<button type="submit" class="btn btn-default btn-warning">Enregistrer</button>
							</div>
						</div>
					</div>
				</form>
				</div> <!-- tab pane Relays-->

            <!-- tab teleinfo -->
            <div class="tab-pane fade" id="tab_tinfo">
                <h4>Données de Téléinformation</h4>
                <div>
                    <span style="float:left;width:18ex;text-align:center;">Charge courante : </span>
                    <div class="progress">
                        <div class="progress-bar progress-bar-success" style="width:0" id="pbar">
                            <span class=show id="pcharge">Attente des données</span>
                        </div>
                    </div>
                </div>

                <table data-toggle="table" data-toolbar="#toolbar" class="table table-striped" data-show-refresh="true" data-show-toggle="true"
                    data-show-columns="true" data-search="true" data-row-style="rowStyle" id="tab_tinfo_data" data-select-item-name="toolbar1">
                    <thead>
                        <tr>
                            <th data-field="na" data-align="left" data-sortable="true" data-formatter="labelFormatter">Etiquette</th>
                            <th data-field="va" data-align="left" data-sortable="true" data-formatter="valueFormatter">Valeur</th>
                        </tr>
                    </thead>
                </table>
            </div> <!-- tab pane teleinfo -->

            <!-- tab Systeme -->
            <div class="tab-pane fade in active" id="tab_sys">
                <h4>Données du système</h4>
                <table data-toggle="table" class="table table-striped table-condensed" data-show-refresh="true" data-show-toggle="true" data-search="true"
                    id="tab_sys_data" data-select-item-name="toolbar2">
                    <thead>
                        <tr>
                            <th data-field="na" data-align="left">Donnée</th>
                            <th data-field="va" data-align="left">Valeur</th>
                        </tr>
                    </thead>
                </table>
            </div> <!-- tab systeme-->

            <!-- tab Configuration -->
            <div class="tab-pane fade" id="tab_cfg">
                <h4>Configuration du système</h4>
                <div>
                    <form class="form-horizontal row-border" method="post" data-toggle="validator" id="frm_config" action="">
                        <input type="hidden" name="save" value="1">

                        <!--RESTRICT_ON-->
                        <!-- Panel config Wi-Fi -->
                        <div class="panel-group" id="pan_cfg">
                            <div class="panel panel-primary">
                                <div class="panel-heading clearfix">
                                    <h3 class="panel-title clickable" data-toggle="collapse" data-parent="#pan_cfg" data-target="#col_cfg">
                                        <span class="glyphicon glyphicon-wrench"></span>&nbsp;Générale<span
                                            class="pull-right glyphicon glyphicon-chevron-up"></span>
                                    </h3>
                                </div>
                                <div class="panel-collapse collapse in" id="col_cfg">
                                    <div class="panel-body">

                                        <!-- nom du réseau -->
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Réseau Wi-Fi</label>
                                            <div class="col-sm-9">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="ssid" name="ssid" maxlength="32" value=""
                                                        placeholder="Nom de votre réseau Wi-Fi">
                                                    <div class="input-group-btn">
                                                        <button class="btn btn-default dropdown-toggle" type="button" id="btn_scan" data-toggle="modal"
                                                            data-target="#tab_scan">&nbsp;<span class="glyphicon glyphicon-zoom-in"></span></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- mot de passe -->
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Clé Wi-Fi</label>
                                            <div class="col-sm-9">
                                                <input type="password" class="form-control" id="psk" name="psk" maxlength="64" value=""
                                                    placeholder="Clé de votre reseau Wi-Fi">
                                            </div>
                                        </div>

                                        <!-- nom sur le LAN -->
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Nom réseau</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="host" name="host" maxlength="32" value=""
                                                    placeholder="Nom réseau du module">
                                            </div>
                                        </div>

                                        <!-- basic auth username -->
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Utilisateur du module</label>
                                            <div class="col-sm-9">
                                                <input type="username" class="form-control" id="username" name="username" maxlength="31" value=""
                                                    placeholder="Nom utilisateur">
                                            </div>
                                        </div>

                                        <!-- basic auth password -->
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Mot de passe du module</label>
                                            <div class="col-sm-9">
                                                <input type="password" class="form-control" id="password" name="password" maxlength="31" value=""
                                                    placeholder="Mot de passe">
                                            </div>
                                        </div>

                                    </div> <!-- panel body-->
                                    <div class="panel-footer">
                                        <div class="text-center">
                                            <div class="btn-group">
                                                <button type="submit" class="btn btn-default btn-primary">Enregistrer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- panel config Wi-Fi -->
                        <!--RESTRICT_OFF-->
                        <!-- Panel HTTP Request -->
                        <div class="panel-group" id="pan_httpReq">
                            <div class="panel panel-info">
                                <div class="panel-heading clearfix">
                                    <h3 class="panel-title clickable" data-toggle="collapse" data-parent="#pan_httpReq" data-target="#col_httpReq">
                                        <span class="glyphicon glyphicon-globe"></span>&nbsp;Requête HTTP<span
                                            class="pull-right glyphicon glyphicon-chevron-down"></span>
                                    </h3>
                                </div>
                                <div class="panel-collapse collapse out" id="col_httpReq">
                                    <div class="panel-body">
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Hostname</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="httpreq_host" name="httpreq_host" maxlength="32"
                                                    placeholder="Hostname">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Port</label>
                                            <div class="col-sm-2">
                                                <input type="text" class="form-control" id="httpreq_port" name="httpreq_port" maxlength="5" placeholder="Port">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">URI</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="httpreq_url" name="httpreq_url" maxlength="150" placeholder="URI">

                                                <label class="checkbox-inline"><input type="checkbox" id="httpreq_use_post" name="httpreq_use_post"
                                                        value="1">Méthode POST (la donnée est le
                                                    dictionnaire JSON)</label>

                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Mise à jour</label>
                                            <div class="col-sm-9">
                                                <select id="httpreq_freq" name="httpreq_freq" class="form-control col-sm-2">
                                                    <option value="0">désactivée</option>
                                                    <option value="15">toutes les 15 secondes</option>
                                                    <option value="30">toutes les 30 secondes</option>
                                                    <option value="60">toutes les minutes</option>
                                                    <option value="300">toutes les 5 minutes</option>
                                                    <option value="900">tous les 1/4 d'heure</option>
                                                    <option value="1800">toutes les 1/2 heure</option>
                                                    <option value="3600">toutes les heures</option>
                                                    <option value="21600">toutes les 6 heures</option>
                                                    <option value="42300">toutes les 12 heures</option>
                                                    <option value="86400">tous les jours</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Déclencheurs</label>
                                            <div class="col-sm-9">
                                                <label class="checkbox-inline"><input type="checkbox" id="httpreq_trigger_ptec" name="httpreq_trigger_ptec"
                                                        value="1">Changement PTEC</label>
                                                <label class="checkbox-inline"><input type="checkbox" id="httpreq_trigger_adps" name="httpreq_trigger_adps"
                                                        value="1">ADPS</label>
                                                <label class="checkbox-inline"><input type="checkbox" id="httpreq_trigger_seuils" name="httpreq_trigger_seuils"
                                                        value="1">Seuils</label>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Seuils</label>
                                            <div class="col-sm-9">
                                                <div class="form-group">
                                                    <div class="col-sm-3">
                                                        <input type="text" class="form-control" id="httpreq_seuil_bas" name="httpreq_seuil_bas" maxlength="5"
                                                            placeholder="Seuil bas">
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <input type="text" class="form-control" id="httpreq_seuil_haut" name="httpreq_seuil_haut" maxlength="5"
                                                            placeholder="Seuil haut">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="panel-footer">
                                        <div class="text-center">
                                            <div class="btn-group">
                                                <button type="submit" class="btn btn-default btn-warning">Enregistrer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- panel HTTP request -->

                        <!-- panel Advanced -->
                        <div class="panel-group" id="pan_advanced">
                            <div class="panel panel-danger">
                                <div class="panel-heading">
                                    <h3 class="panel-title clickable" data-toggle="collapse" data-parent="#pan_advanced" data-target="#col_advanced">
                                        <span class="glyphicon glyphicon-cog"></span>&nbsp;Avancée<span
                                            class="pull-right glyphicon glyphicon-chevron-down"></span>
                                    </h3>
                                </div>
                                <div class="panel-collapse collapse out" id="col_advanced">

                                    <div class="panel-body">
                                        <!--RESTRICT_ON-->
                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Clé en mode AP</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="ap_psk" name="ap_psk" maxlength="64" value=""
                                                    placeholder="Laisser vide pour un point d'accès ouvert">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Mot de passe OTA</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="ota_auth" name="ota_auth" placeholder="Mot de passe OTA">
                                                <span class="help-block">Laisser vide pour désactiver l"authentification
                                                    par mot de passe pour les mise à jour.</span>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">OTA Port</label>
                                            <div class="col-sm-9">
                                                <input type="number" class="form-control" id="ota_port" name="ota_port" size="5" min="1024" max="65534"
                                                    placeholder="Port OTA">
                                            </div>
                                        </div>
                                        <!--RESTRICT_OFF-->

                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Délai minimal entre mises à jour SSE</label>
                                            <div class="col-sm-9">
                                                <input type="number" class="form-control" id="sse_freq" name="sse_freq" size="5" min="0" max="360"
                                                    placeholder="secondes">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="col-sm-3 control-label">Options actives</label>
                                            <div class="col-sm-9">
                                                <label class="checkbox-inline"><input type="checkbox" id="cfg_led_tinfo" name="cfg_led_tinfo" value="1">LED
                                                    Teleinfo</label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="panel-footer">
                                        <div class="text-center">
                                            <div class="btn-group">
                                                <button class="btn btn-danger" id="btn_reboot">Redémarrer WiFinfo</button>
                                            </div>
                                            <!--RESTRICT_ON-->
                                            <div class="btn-group">
                                                <button class="btn btn-danger" data-toggle="modal" data-target="#confirm-raz">RAZ Usine</button>
                                            </div>
                                            <!--RESTRICT_OFF-->
                                            <div class="btn-group">
                                                <button type="submit" class="btn btn-default btn-success">Enregistrer</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- advanced -->

                    </form> <!-- config form -->

                    <!--RESTRICT_ON-->
                    <!-- upload firmware -->
                    <div class="panel panel-danger">
                        <div class="panel-heading clearfix">
                            <h3 class="panel-title">Mise à jour firmware ou serveur web embarqué</h3>
                        </div>
                        <div class="panel-body">
                            <div class="row">
                                <form method='POST' id='frm_fw' action='/noupdate' enctype='multipart/form-data'>
                                    <div class="col-xs-9">
                                        <div class="input-group">
                                            <span class="input-group-btn">
                                                <span class="btn btn-info btn-file">Sélectionner&hellip;
                                                    <input id="file_fw" type="file" name="update"></input>
                                                </span>
                                            </span>
                                            <input id="txt_upload_fw" type="text" size="32" class="form-control"
                                                placeholder="Aucun fichier firmware.bin ou erfs.bin choisi" readonly>
                                        </div>
                                    </div>
                                    <div class="col-xs-3">
                                        <!--<input class="btn btn-danger hide" type="button" id="btn_upload_fw" onclick="Sendfile('fw');" value=""/>-->
                                        <input class="btn btn-danger hide" type="button" id="btn_upload_fw" value="" />
                                    </div>
                                </form>
                            </div>
                            </p>
                            <div id='pgfw' class='hide'>
                                <span id='sfw' style="float:left;width:18ex;text-align:center;"></span>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-success" style="width:0" id="pfw">
                                        <span id="psfw"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="panel-footer">
                            <p id="fw_info"></p>
                        </div>
                    </div> <!-- upload firmware -->
                    <!--RESTRICT_OFF-->
                </div>
            </div> <!-- tab config-->

        </div> <!-- tab content-->

        <!--RESTRICT_ON-->
        <!-- Modal Confirm -->
        <div class="modal fade" id="confirm-raz" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h4 class="modal-title" id="myModalLabel">Confirmez la Remise à Zéro</h4>
                    </div>
                    <div class="modal-body">
                        <p>Vous allez effectuer une remise à zéro du module WifInfo, cette procédure est irréversible et
                            vous allez très certainement perdre votre connexion courante.</p>
                        <p>Tout le système de fichiers va être vidé et vous allez devoir recharger tous les fichiers
                            nécessaires au bon fonctionnement.</p>
                        <p>Voulez-vous vraiment continuer?</p>
                        <p class="debug-url"></p>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Annuler</button>
                        <button type="button" class="btn btn-danger" data-dismiss="modal" id="btn_reset">Oui tout
                            effacer</button>
                    </div>
                </div>
            </div>
        </div> <!-- Modal Confirm -->

        <!-- Modal Wifi Scan -->
        <div class="modal fade" id="tab_scan" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title">Liste des réseaux Wi-Fi</h4>
                    </div>
                    <div class="modal-body">
                        <table id="tab_scan_data" class="table" data-toggle="table" data-cache="false" data-sort-name="rssi" data-sort-order="desc"
                            data-show-refresh="true" data-show-loading="true">
                            <thead>
                                <tr>
                                    <th class="col-sm-5" data-field="ssid" data-sortable="true">SSID</th>
                                    <th class="col-sm-4" data-field="signal" data-align="center" data-formatter="RSSIFormatter">Qualité</th>
                                    <th class="col-sm-3" data-field="rssi" data-sortable="true" data-sort-order="asc" data-align="center">RSSI (dBm)</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-error" data-dismiss="modal">Annuler</button>
                    </div>
                </div>
            </div>
        </div> <!-- modal Wifi Scan -->
        <!--RESTRICT_OFF-->

        <!-- Modal Reboot -->
        <div class="modal fade" id="mdl_wait" data-keyboard="false">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Redémarrage WifInfo en cours</h4>
                    </div>
                    <div class="modal-body">
                        <p class="text-center" id="txt_srv"></p>
                        <p class="text-center">
                            <span class="glyphicon glyphicon-refresh glyphicon-refresh-animate" style="font-size: 3.5em;">
                            </span>
                        </p>
                        <p class="text-center" id="txt_elapsed"></p>
                    </div>
                </div>
            </div>
        </div> <!-- Modal Reboot -->

    </div> <!-- Container -->

    <script>
        var Timer_sys;
        var Timer_tinfo;
        var counters = {};
        var isousc, iinst;
        var elapsed = 0;
        var source = null;

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' Bytes';
            if (bytes < (1024 * 1024)) return (bytes / 1024).toFixed(0) + ' KB';
            if (bytes < (1024 * 1024 * 1024)) return (bytes / 1024 / 1024).toFixed(0) + ' MB';
            return (bytes / 1024 / 1024 / 1024).toFixed(0) + ' GB';
        }

        function rowStyle(row, index) {
            //var classes=['active','success','info','warning','danger'];
            var flags = parseInt(row.fl, 10);
            if (flags & 0x80) return {
                classes: 'danger'
            };
            if (flags & 0x02) return {
                classes: 'warning'
            };
            if (flags & 0x08) return {
                classes: 'success'
            };
            return {};
        }
        function relayFormatter(value, row, index) {
                var name = this.field + '-' + index;
                return '\
                    <div >\
                        <label class="switch">\
                          <input type="checkbox" name="'+name +'" id="'+name +'" ' + (value  ? 'checked="checked"' : '') + ' >\
                          <span class="slider round"></span>\
                        </label>\
                    </div>\
                    ';
                //return '<input type=checkbox name="'+name +'"' + (value  ? 'checked="checked"' : '') + '>';
		}
			
        function labelFormatter(value, row) {
            // var flags = parseInt(row.fl, 10);
            // if (typeof counters[value] === 'undefined')
            //     counters[value] = 1;
            // if (flags & 0x88)
            //     counters[value]++;
            return value;//+ ' <span class=\"badge\">' + counters[value] + '</span>';
        }

        function valueFormatter(value, row) {
            if (row.na == "ISOUSC") {
                isousc = parseInt(value);
            }
            else if (row.na == "IINST") {
                var pe, cl;
                iinst = parseInt(value);
                pe = parseInt(iinst * 100 / isousc);
                if (isNaN(pe))
                    pe = 0;
                cl = 'success';
                if (pe > 70) cl = 'info';
                if (pe > 80) cl = 'warning';
                if (pe > 90) cl = 'danger';

                cl = 'progress-bar-' + cl;
                if (pe > 0)
                    $('#scharge').text(pe + '%');
                if (typeof isousc != 'undefined')
                    $('#pcharge').text(iinst + 'A / ' + isousc + 'A');
                $('#pbar').attr('class', 'progress-bar ' + cl);
                $('#pbar').css('width', pe + '%');
            }

            if (!isNaN(value)) {
                var ref = counters[row.na];
                if (isNaN(ref) || ref == value)
                    ; // value= value + ' <span class="glyphicon glyphicon-triangle-right"></span>';
                else if (ref < value)
                    value = value + ' <span class="glyphicon glyphicon-triangle-top"></span>';
                else if (ref > value)
                    value = value + ' <span class="glyphicon glyphicon-triangle-bottom"></span>';
                else
                    value = value + ' ??';
                counters[row.na] = value;
                return value;
            }

            return value;
        }

        //<!--RESTRICT_ON-->
        function fileFormatter(value, row) {
            var fname = row.na;
            var htm = '';

            //ht+= '<button type="button" class="btn btn-xs btn-danger" title="Supprimer">';
            //ht+= '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>&nbsp;';
            //ht+= '</button>&nbsp;';
            //ht+= '<button type="button" class="btn btn-xs btn-primary" title="Télécharger">';
            //ht+= '<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>&nbsp;';
            //ht+= '</button>&nbsp;';
            htm += '<a href="' + fname + '">' + fname + '</a>';

            return htm;
        }

        function RSSIFormatter(value, row) {
            var rssi = parseInt(row.rssi);
            var signal = Math.min(Math.max(2 * (rssi + 100), 0), 100);
            var cl, htm;
            cl = 'success';
            if (signal < 70) cl = 'info';
            if (signal < 50) cl = 'warning';
            if (signal < 30) cl = 'danger';

            cl = 'progress-bar-' + cl;
            htm = "<div class='progress progress-tbl'>";
            htm += "<div class='progress-bar " + cl + "' role='progressbar' aria-valuemin='0' aria-valuemax='100' ";
            htm += "aria-valuenow='" + signal + "' style='width:" + signal + "%'>" + rssi + "dB</div></div>";
            return htm;
        }

        function progressUpload(data) {
            if (data.lengthComputable) {
                var pe = (data.loaded / data.total * 100).toFixed(0);
                $('#pfw').css('width', pe + '%');
                $('#psfw').text(formatSize(data.loaded) + ' / ' + formatSize(data.total));
            }
        }
        //<!--RESTRICT_OFF-->

        function Notify(mydelay, myicon, mytype, mytitle, mymsg) {
            $.notify({
                icon: 'glyphicon glyphicon-' + myicon,
                title: '&nbsp;<strong>' + mytitle + '</strong>',
                message: '<p>' + mymsg + '</p>',
            }, {
                type: mytype,
                //showProgressbar: true,
                animate: {
                    enter: 'animated fadeInDown',
                    exit: 'animated fadeOutUp',
                    delay: mydelay * 1000
                }
            });
        }

        function waitReboot() {
            var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') + '/#tab_sys';
            $('#txt_srv').text('Tentative de connexion à ' + url);
            $('#mdl_wait').modal();

            var thistimer = setInterval(function () {
                $.ajax({
                    cache: false,
                    type: 'GET',
                    url: '/hb.htm',
                    timeout: 900,
                    success: function (data, textStatus, XMLHttpRequest) {
                        console.log(data);
                        if (data === 'OK') {
                            $('#mdl_wait').modal('hide');
                            clearInterval(thistimer);
                            window.location = url;
                            location.reload();
                            elapsed = 0;
                        }
                    }
                });
                elapsed++;
                $('#txt_elapsed').text('Temps écoulé ' + elapsed + ' s');
            }, 1000);
        }

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            clearTimeout(Timer_sys);
            clearTimeout(Timer_tinfo);
            var target = $(e.target).attr("href")
            console.log('activated ' + target);

            // ferme l'event source
            if (!!source) {
                console.log("close event source");
                source.close();
                source = null;
            }

            // efface les badges des onglets
            $('#scharge').text("");

            // IE10, Firefox, Chrome, etc.
            if (history.pushState)
                window.history.pushState(null, null, target);
            else
                window.location.hash = target;

            if (target == '#tab_tinfo') {
                $('#tab_tinfo_data').bootstrapTable('refresh', {
                    silent: false,
                    url: '/tinfo.json'
                });

            } else if (target=='#tab_relays') {
					$('#tab_relays_data').bootstrapTable('refresh',{silent:true, url:'/relays.json'});  
            } 
            else if (target == '#tab_sys') {
                $('#tab_sys_data').bootstrapTable('refresh', {
                    silent: true,
                    url: '/system.json'
                });
            } else if (target == '#tab_cfg') {
                $.getJSON("/config.json", function (form_data) {
                    $("#frm_config").autofill(form_data);
                })
                    .fail(function () {
                        console.log("error while requestiong configuration data");
                    })

                $('#tab_scan_data').bootstrapTable('refresh', {
                    silent: true,
                    showLoading: true,
                    url: '/wifiscan.json'
                });

            } else if (target == '#tab_gauges') {
                if (!!window.EventSource) {
                    source = new EventSource('/sse/json');
                    console.log("event source created");
                }
                source.addEventListener('message', function (e) {
                    console.log(e.data);
                    var tic = JSON.parse(e.data);
                    gaugePAPP.value = tic.PAPP;
                    gaugeIINST.value = tic.IINST;
                    // $("#HCHP").text((tic.HCHP / 1000).toFixed(3) + "");
                    // $("#HCHC").text((tic.HCHC / 1000).toFixed(3) + "");
                    $("#BBRHCJB").text((tic.BBRHCJB / 1000).toFixed(1) + "")
                                .removeClass("tempo_color");
                    $("#BBRHPJB").text((tic.BBRHPJB / 1000).toFixed(1) + "")
                                .removeClass("tempo_color");
                    $("#BBRHCJW").text((tic.BBRHCJW / 1000).toFixed(1) + "")
                                .removeClass("tempo_color");
                    $("#BBRHPJW").text((tic.BBRHPJW / 1000).toFixed(1) + "")
                                .removeClass("tempo_color");
                    $("#BBRHCJR").text((tic.BBRHCJR / 1000).toFixed(1) + "")
                                .removeClass("tempo_color");
                    $("#BBRHPJR").text((tic.BBRHPJR / 1000).toFixed(1) + "")
                                .removeClass("tempo_color");
                    const regex = /[A-Z]+/;
                    var tarif = tic.OPTARIF.match(regex)[0]; // strip BBR status
                    $("#"+tarif+tic.PTEC).addClass("tempo_color");
                }, false);

            }

        });

        $('#tab_tinfo_data').on('load-success.bs.table', function (e, data) {
            console.log('#tab_tinfo_data loaded');
            if ($('.nav-tabs .active > a').attr('href') == '#tab_tinfo')
                Timer_tinfo = setTimeout(function () {
                    $('#tab_tinfo_data').bootstrapTable('refresh', {
                        silent: true
                    })
                }, 5000);
        });
        $('#tab_relays').on('load-success.bs.table', function (e, data) {
            console.log('#tab_relays loaded');
            $('#switch-0').change(function () {
                    $.post('/switch',{"switch":0, "on": this.checked});
                    return false;
                });
            $('#switch-1').change(function () {
                $.post('/switch',{"switch":1, "on": this.checked});
                return false;
            });
        });

        $('#tab_sys_data').on('load-success.bs.table', function (e, data) {
            console.log('#tab_sys_data loaded');
            if ($('.nav-tabs .active > a').attr('href') == '#tab_sys')
                Timer_sys = setTimeout(function () {
                    $('#tab_sys_data').bootstrapTable('refresh', {
                        silent: true
                    })
                }, 1000);
        })

        //<!--RESTRICT_ON-->

        $('#tab_scan').on('click-row.bs.table', function (e, name, args) {
            // var $form = $('#tab_cfg');
            $('#ssid').val(name.ssid);
            setTimeout(function () {
                $('#psk').focus()
            }, 500);
            $('#tab_scan').modal('hide');
        });

        $('#btn_scan').click(function () {
            $('#tab_scan_data').bootstrapTable('refresh', {
                url: '/wifiscan.json',
                showLoading: false,
                silent: true
            });
        });

        $('#btn_reset').click(function () {
            $.post('/factory_reset');
            waitReboot();
            return false;
        });
        //<!--RESTRICT_OFF-->

        $('#btn_reboot').click(function () {
            $.post('/reset');
            waitReboot();
            return false;
        });
        

        $(document)
            .on('change', '.btn-file :file', function () {
                var input = $(this),
                    numFiles = input.get(0).files ? input.get(0).files.length : 1,
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
                input.trigger('fileselect', [numFiles, label]);
                
            })
            .on('show.bs.collapse', '.panel-collapse', function () {
                var $span = $(this).parents('.panel').find('span.pull-right.glyphicon');
                $span.removeClass('glyphicon-chevron-down').addClass('glyphicon-chevron-up');
            })
            .on('hide.bs.collapse', '.panel-collapse', function () {
                var $span = $(this).parents('.panel').find('span.pull-right.glyphicon');
                $span.removeClass('glyphicon-chevron-up').addClass('glyphicon-chevron-down');
            });

        $('#frm_config').validator().on('submit', function (e) {
            // everything looks good!
            if (!e.isDefaultPrevented()) {
                e.preventDefault();
                console.log("Form Submit");

                $.post('/config_form.json', $("#frm_config").serialize())
                    .done(function (msg, textStatus, xhr) {
                        Notify(2, 'ok', 'success', 'Enregistrement effectué', xhr.status + ' ' + msg);
                    })
                    .fail(function (xhr, textStatus, errorThrown) {
                        Notify(4, 'remove', 'danger', 'Erreur lors de l\'enregistrement', xhr.status + ' ' + errorThrown);
                    });
            }
        });
        $('#frm_relays').validator().on('submit', function (e) {
            // everything looks good!
            if (!e.isDefaultPrevented()) {
                e.preventDefault();
                console.log("Form Submit");

                $.post('/relays_form.json', $("#frm_relays").serialize())
                    .done(function (msg, textStatus, xhr) {
                        Notify(2, 'ok', 'success', 'Enregistrement effectué', xhr.status + ' ' + msg);
                    })
                    .fail(function (xhr, textStatus, errorThrown) {
                        Notify(4, 'remove', 'danger', 'Erreur lors de l\'enregistrement', xhr.status + ' ' + errorThrown);
                    });
            }
        });

        //<!--RESTRICT_ON-->
        // sélection fichier de firmware
        $('#file_fw').change(function () {
            var $txt = $('#txt_upload_fw');
            var $btn = $('#btn_upload_fw');
            var ok = true;
            var f = this.files[0];
            var name = f.name.toLowerCase();
            var html = f.type + ' - taille:' + f.size + '&nbsp;octets'

            var is_filesystem = name.match("fs.bin$");
            var is_firmware = name.match(".bin$") && !is_filesystem;

            $('#pgfw').removeClass('show').addClass('hide');
            $('#sfw').text(name + ' : ');

            if (!f.type.match('application/macbinary') && !f.type.match('application/octet-stream')) {
                Notify(3, 'remove', 'danger', 'Type de fichier non conforme', 'Le fichier de mise à jour doit être un fichier binaire');
                ok = false;
            } else if (!is_filesystem && !is_firmware) {
                Notify(5, 'remove', 'danger', 'Nom de fichier incorrect',
                    'Le fichier de mise à jour doit être nommé: <ul><li>firmware.bin (Logiciel)</li><li>erfs.bin (Système de fichiers)</li></ul>');
                ok = false;
            }
            if (ok) {
                // met le nom de fichier dans la zone de texte
                $txt.attr('readonly', '');
                $txt.val(f.name);
                $txt.attr('readonly', 'readonly');

                $btn.removeClass('hide');
                if (is_firmware) {
                    label = 'Mise à jour Logiciel';
                } else {
                    label = 'Mise à jour Web';
                }
                $btn.val(label);
                $('#fw_info').html('<strong>' + label + '</strong> ' + html);
            } else {
                $txt.attr('readonly', '');
                $txt.val('');
                $txt.attr('readonly', 'readonly');
                $btn.addClass('hide');
                $('#fw_info').html("");

            }
            return ok;
        });

        $('#btn_upload_fw').click(function () {
            var formData = new FormData($('#frm_fw')[0]);
            $.ajax({
                url: '/update',
                type: 'POST',
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                xhr: function () {
                    var myXhr = $.ajaxSettings.xhr();
                    if (myXhr.upload)
                        myXhr.upload.addEventListener('progress', progressUpload, false);
                    return myXhr;
                },
                beforeSend: function () {
                    $('#pgfw').removeClass('hide');
                },
                success: function (msg, textStatus, xhr) {
                    Notify(2, 'floppy-saved', 'success', 'Envoi de la mise à jour terminé',
                        '<strong>' + xhr.status + '</strong> ' + msg);
                    waitReboot();
                },
                error: function (xhr, textStatus, errorThrown) {
                    $('#pfw').removeClass('progress-bar-success').addClass('progress-bar-danger');
                    Notify(4, 'floppy-remove', 'danger', 'Erreur lors de la mise à jour',
                        '<strong>' + xhr.status + '</strong> ' + errorThrown);
                }
            });
        });
        //<!--RESTRICT_OFF-->

        window.onload = function () {
            var url = document.location.toString();

            if (url.match('#')) {
                $('.nav-tabs a[href=#' + url.split('#')[1] + ']').tab('show');
                console.log("show frame " + url)
            }

            $('.nav-tabs a[href=#' + url.split('#')[1] + ']').on('shown', function (e) {
                window.location.hash = e.target.hash;
            });

            $('#tab_tinfo_data').bootstrapTable('refresh', {
                silent: true,
                url: '/tinfo.json'
            });

            $.get("/version", function (data) {
                $('#version').text(data);
            });
        };
    </script>

    <script>
        var gaugePAPP = new RadialGauge({
            renderTo: 'gauge-papp',
            width: 200,
            height: 200,
            units: 'VA',
            title: false,
            value: 0,
            valueInt: 1,
            valueDec: 0,
            minValue: 0,
            maxValue: 9000,
            majorTicks: [0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000],
            minorTicks: 5,
            strokeTicks: true,
            highlights: [
                { from: 4000, to: 6000, color: 'rgba(78,78,78,0.2)' },
                { from: 6000, to: 9000, color: 'rgba(255,0,0,0.75)' }
            ],
            borders: false,
            borderShadowWidth: 0,
            needleType: "arrow",
            needleWidth: 2,
            needleCircleSize: 7,
            needleCircleOuter: true,
            needleCircleInner : false,
            colorPlate: '#fff',
            colorMajorTicks: '#000',
            colorMinorTicks: '#111',
            colorTitle: '#fff',
            colorUnits: '#111',
            colorNumbers: '#222',
            colorNeedle: 'rgba(240,128,128,1)',
            colorNeedleEnd: 'rgba(255,160,122,.9)',
            valueBox: true,
            colorValueBoxBackground: '#fff',
            colorValueBoxRect:'#000',
            colorValueBoxRectEnd: "#000",
            valueBoxStroke:1,
            //animationRule: 'bounce',
            //animationDuration: 0

        });
        gaugePAPP.draw();

        var gaugeIINST = new RadialGauge({
            renderTo: 'gauge-iinst',
            width: 200,
            height: 200,
            units: 'A',
            title: false,
            value: 0,
            valueInt: 1,
            valueDec: 0,
            minValue: 0,
            maxValue: 50,
            majorTicks: [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50],
            minorTicks: 5,
            strokeTicks: true,
            highlights: [
                { from: 30, to: 40, color: 'rgba(78,78,78,0.2)' },
                { from: 40, to: 50, color: 'rgba(255,0,0,0.75)' }
            ],
            borders: false,
            borderShadowWidth: 0,
            needleType: "arrow",
            needleWidth: 2,
            needleCircleSize: 7,
            needleCircleOuter: true,
            needleCircleInner : false,
            colorPlate: '#fff',
            colorMajorTicks: '#000',
            colorMinorTicks: '#111',
            colorTitle: '#000',
            colorUnits: '#111',
            colorNumbers: '#000',
            colorNeedle: 'rgba(240, 128, 128, 1)',
            colorNeedleEnd: 'rgba(255, 160, 122, .9)',
            valueBox: true,
            colorValueBoxBackground: '#fff',
            colorValueBoxRect:'#000',
            colorValueBoxRectEnd: "#000",
            valueBoxStroke:1,
            //animationRule: 'bounce',
            //animationDuration: 0

        });
        gaugeIINST.draw();
    </script>

    <div class="text-center">
        <small>
            <br />
            Module Wi-Fi de téléinformation -
            <a href="https://rene-d.github.io/wifinfo">site web</a> - <a href="https://github.com/FrColin/wifinfo">
                <svg height="16" viewBox="0 0 16 16" version="1.1" width="16" aria-hidden="true">
                    <path fill-rule="evenodd"
                        d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
                    </path>
                </svg>
                &nbsp;GitHub</a> - version <span id="version"></span>
        </small>
    </div>
</body>

</html>
